{% extends "layout.html" %}

{% block content %}

<style>
/* ---------- DEFAULT (DESKTOP) ---------- */
video {
    border-radius: 12px;
}

/* ---------- MOBILE OPTIMIZATION ---------- */
@media (max-width: 768px) {

    h3 {
        font-size: 26px;
    }

    h5 {
        font-size: 22px;
    }

    p {
        font-size: 18px;
    }

    .card {
        padding: 20px !important;
        margin-bottom: 20px;
    }

    input[type="file"] {
        font-size: 18px;
        padding: 12px;
    }

    button {
        font-size: 20px !important;
        padding: 14px !important;
        border-radius: 12px;
    }

    #timerDisplay {
        font-size: 22px !important;
    }

    video {
        height: auto;
        max-height: 320px;
    }

    .row {
        gap: 20px;
    }
}
</style>


<div class="card p-4">

<h3 class="text-center mb-4">
    <i class="bi bi-camera-video"></i>
    Upload or Record Monthly Video
</h3>

<p class="text-warning text-center fw-bold">
    Note: Video recording is limited to 1 minute maximum.
</p>

<div class="row">

<!-- LEFT SIDE - UPLOAD FROM DEVICE -->
<div class="col-md-6">
    <div class="card p-3">

        <h5 class="text-center">Upload Existing Video</h5>

        <form method="POST" enctype="multipart/form-data">

            <input type="file"
                   name="video"
                   accept="video/*"
                   class="form-control mt-3"
                   required>

            <button class="btn btn-custom w-100 mt-3">
                Upload Video
            </button>

        </form>

    </div>
</div>


<!-- RIGHT SIDE - RECORD VIDEO -->
<div class="col-md-6">
    <div class="card p-3">

        <h5 class="text-center">Record Video Now</h5>

        <video id="preview" autoplay muted class="w-100 mt-2"></video>

        <div class="text-center mt-3">

            <div id="timerDisplay"
                 class="fw-bold text-danger mb-2"
                 style="font-size:20px;">
                60 seconds remaining
            </div>

            <button id="startBtn" class="btn btn-success">
                Start Recording
            </button>

            <button id="stopBtn" class="btn btn-danger" disabled>
                Stop Recording
            </button>

        </div>

        <video id="recordedVideo" controls class="w-100 mt-3"></video>

        <form id="recordUploadForm" method="POST" enctype="multipart/form-data">
            <input type="file" name="video" id="recordedFile" hidden>

            <button id="uploadRecorded"
                    class="btn btn-custom w-100 mt-3"
                    disabled>
                Upload Recorded Video
            </button>
        </form>

    </div>
</div>

</div>

</div>


<script>

let mediaRecorder;
let recordedChunks = [];
let countdown;
let timeLeft = 60;


// Access Camera
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
    document.getElementById("preview").srcObject = stream;

    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = function(e) {
        recordedChunks.push(e.data);
    }

    mediaRecorder.onstop = function() {

        clearInterval(countdown);
        document.getElementById("timerDisplay").innerText =
            "Recording stopped";

        let blob = new Blob(recordedChunks, { type: 'video/webm' });

        let url = URL.createObjectURL(blob);

        document.getElementById("recordedVideo").src = url;

        let file = new File([blob], "recorded_video.webm", {
            type: "video/webm"
        });

        let dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);

        document.getElementById("recordedFile").files =
            dataTransfer.files;

        document.getElementById("uploadRecorded").disabled = false;

        recordedChunks = [];
    }
});


// START RECORDING
document.getElementById("startBtn").onclick = function() {

    timeLeft = 60;

    document.getElementById("timerDisplay").innerText =
        timeLeft + " seconds remaining";

    mediaRecorder.start();

    this.disabled = true;
    document.getElementById("stopBtn").disabled = false;

    countdown = setInterval(function() {

        timeLeft--;

        document.getElementById("timerDisplay").innerText =
            timeLeft + " seconds remaining";

        if (timeLeft <= 0) {

            mediaRecorder.stop();

            clearInterval(countdown);

            document.getElementById("timerDisplay").innerText =
                "Time limit reached (1 minute)";

            document.getElementById("startBtn").disabled = false;
            document.getElementById("stopBtn").disabled = true;
        }

    }, 1000);
}


// STOP RECORDING MANUALLY
document.getElementById("stopBtn").onclick = function() {

    mediaRecorder.stop();

    clearInterval(countdown);

    document.getElementById("startBtn").disabled = false;
    this.disabled = true;
}

</script>

{% endblock %}

